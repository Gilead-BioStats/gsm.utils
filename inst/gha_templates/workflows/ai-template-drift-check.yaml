# gsm.utils GHA version: 0.2.0
# Generated by: https://github.com/Gilead-BioStats/gsm.utils
# Description: Check AI template drift against gsm.utils canonical templates

on:
  pull_request:
    branches: [main, dev]
  workflow_dispatch:

name: ai-template-drift-check

permissions: read-all

jobs:
  ai-template-drift-check:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v5

      - uses: r-lib/actions/setup-r@v2
        with:
          use-public-rspm: true

      - name: Install gsm.utils
        shell: Rscript {0}
        run: |
          install.packages("pak")
          pak::pak("Gilead-BioStats/gsm.utils@ai-playground")

      - name: Check AI template drift
        shell: Rscript {0}
        run: |
          report <- gsm.utils::update_gsm_ai_docs(
            strPackageDir = ".",
            mode = "check",
            fail_on_drift = FALSE
          )

          drift <- report[report$status != "identical", c("relative_path", "status")]

          if (nrow(drift) > 0) {
            message("AI template drift detected:")
            print(drift)
            message("Run gsm.utils::update_gsm_ai_docs(strPackageDir = '.', overwrite = TRUE) and commit changes.")
            quit(status = 1)
          }

          message("No AI template drift detected.")
